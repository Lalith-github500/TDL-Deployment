<!DOCTYPE html>
<html>
<head>
	<title>Todo App</title>
	<style>
		body {
			font-family: Arial;
			max-width: 400px;
			margin: 40px auto;
		}
		input, button {
			padding: 8px;
			margin: 5px 0;
			width: 100%;
		}
		li {
			display: flex;
			justify-content: space-between;
			margin-top: 5px;
		}
		#tasksSection {
			display: none;
		}
	</style>
</head>

<body>

<h2>Signup(If you have already signed up then directly go for login)</h2>
<input id="su_user" placeholder="Username">
<input id="su_pass" type="password" placeholder="Password">
<button onclick="signup()">Signup</button>

<h2>Login</h2>
<input id="li_user" placeholder="Username">
<input id="li_pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>

<hr>

<div id="tasksSection">
	<h2>Tasks</h2>
	<input id="taskInput" placeholder="New task">
	<button onclick="addTask()">Add Task</button>

	<ul id="taskList"></ul>

	<button onclick="logout()">Logout</button>
</div>

<script>
function signup() {
	fetch("/signup", {
		method: "POST",
		headers: {"Content-Type": "application/x-www-form-urlencoded"},
		body: `username=${su_user.value}&password=${su_pass.value}`
	})
	.then(res => res.text())
	.then(alert)
}

function login() {
	fetch("/login", {
		method: "POST",
		headers: {"Content-Type": "application/x-www-form-urlencoded"},
		body: `username=${li_user.value}&password=${li_pass.value}`
	})
	.then(res => res.json())
	.then(data => {
		localStorage.setItem("token", data.token)
		showTasksUI()
		loadTasks()
	})
}

function loadTasks() {
	const token = localStorage.getItem("token")
	if (!token) return

	fetch("/tasks", {
		headers: {"Authorization": token}
	})
	.then(res => res.json())
	.then(tasks => {
		taskList.innerHTML = ""
		tasks.forEach(t => {
			const li = document.createElement("li")
			li.innerHTML = `
				${t.name}
				<button onclick="deleteTask(${t.id})">X</button>
			`
			taskList.appendChild(li)
		})
	})
}

function addTask() {
	const token = localStorage.getItem("token")
	fetch(`/add?name=${taskInput.value}`, {
		headers: {"Authorization": token}
	})
	.then(() => {
		taskInput.value = ""
		loadTasks()
	})
}

function deleteTask(id) {
	const token = localStorage.getItem("token")
	fetch(`/delete?id=${id}`, {
		headers: {"Authorization": token}
	})
	.then(loadTasks)
}

function logout() {
	localStorage.removeItem("token")
	taskList.innerHTML = ""
	document.getElementById("tasksSection").style.display = "none"
	alert("Logged out")
}

function showTasksUI() {
	document.getElementById("tasksSection").style.display = "block"
}

// Auto-login if token exists
if (localStorage.getItem("token")) {
	showTasksUI()
	loadTasks()
}
</script>

</body>
</html>
